"""Move wiki categories from text block to array in the json generated by WikiExtractor.py script."""
import json
import os
import re

import click

CAT_REGEX = re.compile(r'Category\:(?P<cat>.*)')

def move_categories(data):
    """Move categories from text block to category field in the json.

    Args:
        data: dict with info about a single doc
    Returns: dict with info about the single doc, which adds a 'categories' field, and
        removes categories from the text field
    """
    candidate_categories = re.findall(CAT_REGEX, data['text'])
    data['categories'] = [cat.strip() for cat in candidate_categories if len(cat) < 50]
    data['text'] = data['text'].split('Category:')[0]
    return data


@click.command()
@click.option('--input_dir', '-i', help='Input directory')
@click.option('--output_dir', '-o', help='Output directory')
def main(input_dir, output_dir):
    if not os.path.exists(output_dir):
        os.mkdir(output_dir)
    for filename in os.listdir(input_dir):
        with open(os.path.join(input_dir, filename), 'rt', encoding='utf-8') as input_file:
            with open(os.path.join(output_dir, filename), 'wt', encoding='utf-8') as output_file:
                for line in input_file:
                    data = json.loads(line)
                    output_file.write('{}\n'.format(json.dumps(move_categories(data))))


if __name__ == '__main__':
    main()